<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DMARC Report Analyzer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      color: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    header h1 {
      font-size: 1.5em;
    }

    .header-info {
      font-size: 0.85em;
      opacity: 0.9;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background: #45a049;
    }

    .btn-primary:disabled {
      background: #999;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-card .label {
      font-size: 0.85em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      font-size: 2em;
      font-weight: bold;
      color: #1e3a5f;
    }

    .domain-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .domain-header {
      background: #f8f9fa;
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
    }

    .domain-header:hover {
      background: #f0f2f5;
    }

    .domain-name {
      font-size: 1.2em;
      font-weight: 600;
      color: #1e3a5f;
    }

    .domain-stats {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .domain-stats .stat {
      text-align: center;
    }

    .domain-stats .stat-value {
      font-weight: bold;
      font-size: 1.1em;
    }

    .domain-stats .stat-label {
      font-size: 0.75em;
      color: #666;
    }

    .pass-rate {
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .pass-rate.good { background: #d4edda; color: #155724; }
    .pass-rate.warning { background: #fff3cd; color: #856404; }
    .pass-rate.bad { background: #f8d7da; color: #721c24; }

    .domain-body {
      display: none;
      padding: 20px;
    }

    .domain-body.open {
      display: block;
    }

    .section {
      margin-bottom: 25px;
    }

    .section h3 {
      font-size: 1em;
      color: #1e3a5f;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e9ecef;
    }

    .policy-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 500;
    }

    .policy-none { background: #fff3cd; color: #856404; }
    .policy-quarantine { background: #cce5ff; color: #004085; }
    .policy-reject { background: #d4edda; color: #155724; }

    .issue-card {
      background: #fff8f0;
      border-left: 4px solid #e67e22;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 0 6px 6px 0;
    }

    .issue-card.resolved {
      background: #f0fff4;
      border-left-color: #27ae60;
    }

    .issue-title {
      font-weight: 600;
      color: #c0392b;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .issue-count {
      font-size: 0.8em;
      background: #e74c3c;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .issue-explanation {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 10px;
    }

    .issue-remediation {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      font-size: 0.85em;
      white-space: pre-wrap;
      font-family: 'Consolas', 'Monaco', monospace;
    }

    .issue-toggle {
      font-size: 0.8em;
      color: #3498db;
      cursor: pointer;
      margin-top: 8px;
    }

    .issue-toggle:hover {
      text-decoration: underline;
    }

    .trend-chart {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 100px;
      padding: 10px 0;
    }

    .trend-bar-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      min-width: 40px;
    }

    .trend-bar {
      width: 100%;
      max-width: 50px;
      display: flex;
      flex-direction: column;
      border-radius: 4px 4px 0 0;
      overflow: hidden;
    }

    .trend-bar .pass {
      background: #27ae60;
    }

    .trend-bar .fail {
      background: #e74c3c;
    }

    .trend-label {
      font-size: 0.7em;
      color: #666;
      margin-top: 5px;
      text-align: center;
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85em;
    }

    .records-table th,
    .records-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .records-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .records-table tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 500;
    }

    .status-pass { background: #d4edda; color: #155724; }
    .status-fail { background: #f8d7da; color: #721c24; }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1e3a5f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success { background: #27ae60; }
    .toast.error { background: #e74c3c; }

    .expand-icon {
      transition: transform 0.2s;
    }

    .expand-icon.open {
      transform: rotate(180deg);
    }

    .ip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .ip-badge {
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-family: monospace;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h2 {
      margin-bottom: 10px;
      color: #333;
    }

    .records-container {
      max-height: 400px;
      overflow-y: auto;
    }

    .dns-section {
      background: #f0f7ff;
      border: 1px solid #cce0ff;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .dns-section h4 {
      color: #1e3a5f;
      margin-bottom: 10px;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dns-record {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      word-break: break-all;
    }

    .dns-record-label {
      font-weight: 600;
      color: #1e3a5f;
      margin-bottom: 5px;
    }

    .dns-record-value {
      color: #333;
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .dns-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: 500;
      margin-left: 8px;
    }

    .dns-status.found { background: #d4edda; color: #155724; }
    .dns-status.missing { background: #f8d7da; color: #721c24; }
    .dns-status.error { background: #fff3cd; color: #856404; }

    .dns-detail {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .dns-detail-item {
      background: #e9ecef;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.85em;
    }

    .dns-detail-item strong {
      color: #1e3a5f;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      padding: 8px 16px;
      font-size: 0.85em;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .dns-loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .dns-includes {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .dns-include-badge {
      background: #e3f2fd;
      color: #1565c0;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8em;
    }

    .dkim-selector {
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 8px;
    }

    .dkim-selector-name {
      font-weight: 600;
      color: #2e7d32;
    }

    /* Enriched Issue Styles */
    .issue-context {
      background: #fff3e0;
      border-left: 3px solid #ff9800;
      padding: 10px 12px;
      margin: 10px 0;
      font-size: 0.9em;
      color: #e65100;
      border-radius: 0 4px 4px 0;
    }

    .issue-context-label {
      font-weight: 600;
      font-size: 0.8em;
      text-transform: uppercase;
      margin-bottom: 4px;
      color: #ff6d00;
    }

    .relevant-dns {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 6px;
      padding: 12px;
      margin: 10px 0;
    }

    .relevant-dns-title {
      font-weight: 600;
      font-size: 0.85em;
      color: #1565c0;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .relevant-dns-item {
      background: white;
      border: 1px solid #90caf9;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
    }

    .relevant-dns-item:last-child {
      margin-bottom: 0;
    }

    .relevant-dns-type {
      display: inline-block;
      background: #1565c0;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.75em;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .relevant-dns-raw {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      background: #f5f5f5;
      padding: 8px;
      border-radius: 4px;
      word-break: break-all;
      margin: 6px 0;
    }

    .relevant-dns-explanation {
      font-size: 0.85em;
      color: #555;
    }

    .proposed-changes {
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
      border-radius: 6px;
      padding: 12px;
      margin: 10px 0;
    }

    .proposed-changes-title {
      font-weight: 600;
      font-size: 0.85em;
      color: #2e7d32;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .proposed-change {
      background: white;
      border: 1px solid #a5d6a7;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .proposed-change:last-child {
      margin-bottom: 0;
    }

    .proposed-change-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .proposed-change-type {
      display: inline-block;
      background: #2e7d32;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.75em;
      font-weight: 600;
    }

    .proposed-change-priority {
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.7em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .priority-high { background: #ffcdd2; color: #c62828; }
    .priority-medium { background: #fff9c4; color: #f57f17; }
    .priority-low { background: #e0e0e0; color: #616161; }

    .proposed-change-record {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.8em;
      color: #666;
      margin-bottom: 6px;
    }

    .proposed-change-diff {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      margin: 10px 0;
    }

    .diff-label {
      font-size: 0.75em;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 3px;
    }

    .diff-current {
      background: #ffebee;
      color: #c62828;
    }

    .diff-proposed {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .diff-value {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      background: #f5f5f5;
      padding: 8px;
      border-radius: 4px;
      word-break: break-all;
      align-self: center;
    }

    .proposed-change-explanation {
      font-size: 0.85em;
      color: #555;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
    }

    .issue-sections-toggle {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .issue-sections-toggle .toggle-btn {
      font-size: 0.8em;
      color: #3498db;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .issue-sections-toggle .toggle-btn:hover {
      background: #e3f2fd;
    }

    .issue-sections-toggle .toggle-btn.active {
      background: #1976d2;
      color: white;
    }

    .dns-cached-notice {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #e8f5e9;
      border-radius: 4px;
      font-size: 0.85em;
      color: #2e7d32;
      margin-bottom: 12px;
    }

    .dns-stale-notice {
      background: #fff3e0;
      color: #e65100;
    }

    .copy-btn {
      padding: 4px 8px;
      font-size: 0.75em;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 8px;
    }

    .copy-btn:hover {
      background: #e0e0e0;
    }

    /* Record Analysis Styles */
    .record-analysis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .record-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .record-card.has-issues {
      border-color: #ff9800;
    }

    .record-card.no-issues {
      border-color: #4caf50;
    }

    .record-card-header {
      padding: 12px 16px;
      background: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .record-card.has-issues .record-card-header {
      background: #fff3e0;
    }

    .record-card.no-issues .record-card-header {
      background: #e8f5e9;
    }

    .record-type {
      font-weight: 700;
      font-size: 1.1em;
      color: #1e3a5f;
    }

    .record-status {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .record-status-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 600;
    }

    .status-ok { background: #c8e6c9; color: #2e7d32; }
    .status-warning { background: #ffe0b2; color: #e65100; }
    .status-error { background: #ffcdd2; color: #c62828; }
    .status-missing { background: #e0e0e0; color: #616161; }

    .record-card-body {
      padding: 16px;
    }

    .current-record {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .current-record-label {
      font-size: 0.75em;
      font-weight: 600;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .current-record-value {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      word-break: break-all;
      background: white;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .issues-summary {
      margin: 12px 0;
    }

    .issues-summary-title {
      font-size: 0.8em;
      font-weight: 600;
      color: #e65100;
      margin-bottom: 6px;
    }

    .issue-chip {
      display: inline-block;
      background: #fff3e0;
      border: 1px solid #ffcc80;
      color: #e65100;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8em;
      margin: 2px;
    }

    .proposed-record {
      background: #e8f5e9;
      border: 2px solid #4caf50;
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
    }

    .proposed-record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .proposed-record-label {
      font-size: 0.8em;
      font-weight: 700;
      color: #2e7d32;
      text-transform: uppercase;
    }

    .proposed-record-value {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
      background: white;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #a5d6a7;
      word-break: break-all;
      position: relative;
    }

    .proposed-changes-list {
      margin-top: 10px;
      font-size: 0.85em;
    }

    .proposed-changes-list li {
      color: #2e7d32;
      margin: 4px 0;
    }

    .copy-record-btn {
      padding: 6px 12px;
      font-size: 0.8em;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }

    .copy-record-btn:hover {
      background: #43a047;
    }

    .identified-senders {
      margin: 12px 0;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 6px;
    }

    .identified-senders-title {
      font-size: 0.8em;
      font-weight: 600;
      color: #1565c0;
      margin-bottom: 8px;
    }

    .sender-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      background: white;
      border-radius: 4px;
      margin-bottom: 4px;
      font-size: 0.85em;
    }

    .sender-item:last-child {
      margin-bottom: 0;
    }

    .sender-name {
      font-weight: 500;
    }

    .sender-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sender-in-spf {
      color: #2e7d32;
      font-size: 0.8em;
    }

    .sender-missing {
      color: #c62828;
      font-size: 0.8em;
      font-weight: 600;
    }

    .sender-messages {
      color: #666;
      font-size: 0.8em;
    }

    .dkim-proposed-item {
      background: white;
      border: 1px solid #a5d6a7;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
    }

    .dkim-proposed-item:last-child {
      margin-bottom: 0;
    }

    .dkim-selector-name {
      font-weight: 600;
      font-size: 0.85em;
      color: #1e3a5f;
      margin-bottom: 4px;
    }

    .dkim-explanation {
      font-size: 0.8em;
      color: #555;
    }

    .no-changes-needed {
      color: #2e7d32;
      font-size: 0.9em;
      padding: 12px;
      background: #e8f5e9;
      border-radius: 6px;
      text-align: center;
    }

    /* Pagination Styles */
    .pagination-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 10px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pagination-info {
      font-size: 0.85em;
      color: #666;
    }

    .pagination-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pagination-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #e9ecef;
      border-color: #adb5bd;
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-pages {
      display: flex;
      gap: 4px;
    }

    .pagination-page {
      padding: 6px 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      min-width: 36px;
      text-align: center;
    }

    .pagination-page:hover {
      background: #e9ecef;
    }

    .pagination-page.active {
      background: #1e3a5f;
      color: white;
      border-color: #1e3a5f;
    }

    .pagination-page-size {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85em;
      color: #666;
    }

    .pagination-page-size select {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85em;
    }

    /* Issue resolution status */
    .issue-chip.resolved {
      background: #e8f5e9;
      border-color: #a5d6a7;
      color: #2e7d32;
      text-decoration: line-through;
      opacity: 0.8;
    }

    .issue-chip.unresolved {
      background: #fff3e0;
      border-color: #ffcc80;
      color: #e65100;
    }

    .resolution-status {
      font-size: 0.75em;
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }

    .resolution-status.resolved {
      background: #c8e6c9;
      color: #1b5e20;
    }

    .resolution-status.unresolved {
      background: #ffecb3;
      color: #ff6f00;
    }

    .issue-with-status {
      display: inline-flex;
      flex-direction: column;
      align-items: flex-start;
      margin: 4px;
    }

    .issues-summary-resolved {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed #c8e6c9;
    }

    .issues-summary-resolved .issues-summary-title {
      color: #2e7d32;
    }

    .resolved-count {
      display: inline-block;
      background: #c8e6c9;
      color: #1b5e20;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75em;
      margin-left: 8px;
    }

    .unresolved-count {
      display: inline-block;
      background: #ffcc80;
      color: #e65100;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75em;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>DMARC Report Analyzer</h1>
        <div class="header-info">
          Last updated: <span id="lastUpdated">-</span> |
          Files processed: <span id="filesProcessed">0</span>
        </div>
      </div>
      <button class="btn btn-primary" id="refreshBtn" onclick="refreshData()">
        Refresh Reports
      </button>
    </header>

    <div class="stats-grid" id="globalStats">
      <div class="stat-card">
        <div class="label">Total Domains</div>
        <div class="value" id="totalDomains">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Messages</div>
        <div class="value" id="totalMessages">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Overall Pass Rate</div>
        <div class="value" id="overallPassRate">0%</div>
      </div>
      <div class="stat-card">
        <div class="label">Active Issues</div>
        <div class="value" id="totalIssues">0</div>
      </div>
    </div>

    <div id="domainList">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading DMARC data...</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let data = null;

    // Pagination state per domain
    const paginationState = {};
    const DEFAULT_PAGE_SIZE = 25;

    function getPaginationState(domainIndex) {
      if (!paginationState[domainIndex]) {
        paginationState[domainIndex] = { page: 1, pageSize: DEFAULT_PAGE_SIZE };
      }
      return paginationState[domainIndex];
    }

    function changePage(domainIndex, newPage) {
      const state = getPaginationState(domainIndex);
      const domain = data.domains[domainIndex];
      const totalPages = Math.ceil(domain.records.length / state.pageSize);

      if (newPage >= 1 && newPage <= totalPages) {
        state.page = newPage;
        renderRecordsTable(domainIndex);
      }
    }

    function changePageSize(domainIndex, newSize) {
      const state = getPaginationState(domainIndex);
      state.pageSize = parseInt(newSize);
      state.page = 1; // Reset to first page
      renderRecordsTable(domainIndex);
    }

    function renderRecordsTable(domainIndex) {
      const domain = data.domains[domainIndex];
      const state = getPaginationState(domainIndex);
      const container = document.getElementById(`records-table-${domainIndex}`);

      if (!container) return;

      const sortedRecords = [...domain.records].sort((a, b) => b.count - a.count);
      const totalRecords = sortedRecords.length;
      const totalPages = Math.ceil(totalRecords / state.pageSize);
      const startIndex = (state.page - 1) * state.pageSize;
      const endIndex = Math.min(startIndex + state.pageSize, totalRecords);
      const pageRecords = sortedRecords.slice(startIndex, endIndex);

      container.innerHTML = `
        <table class="records-table">
          <thead>
            <tr>
              <th>Source IP</th>
              <th>Count</th>
              <th>DMARC</th>
              <th>DKIM</th>
              <th>SPF</th>
              <th>Header From</th>
            </tr>
          </thead>
          <tbody>
            ${pageRecords.map(record => `
              <tr>
                <td><code>${escapeHtml(record.sourceIp)}</code></td>
                <td>${record.count}</td>
                <td>
                  <span class="status-badge ${record.policyEvaluated.dkim === 'pass' || record.policyEvaluated.spf === 'pass' ? 'status-pass' : 'status-fail'}">
                    ${record.policyEvaluated.dkim === 'pass' || record.policyEvaluated.spf === 'pass' ? 'PASS' : 'FAIL'}
                  </span>
                </td>
                <td>
                  <span class="status-badge ${record.policyEvaluated.dkim === 'pass' ? 'status-pass' : 'status-fail'}">
                    ${record.policyEvaluated.dkim.toUpperCase()}
                  </span>
                </td>
                <td>
                  <span class="status-badge ${record.policyEvaluated.spf === 'pass' ? 'status-pass' : 'status-fail'}">
                    ${record.policyEvaluated.spf.toUpperCase()}
                  </span>
                </td>
                <td>${escapeHtml(record.identifiers.headerFrom)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        ${renderPaginationControls(domainIndex, totalRecords, totalPages, state.page, state.pageSize, startIndex, endIndex)}
      `;
    }

    function renderPaginationControls(domainIndex, totalRecords, totalPages, currentPage, pageSize, startIndex, endIndex) {
      if (totalRecords <= 10) return ''; // No pagination needed for very small sets

      // Generate page buttons (show max 5 pages)
      let pageButtons = '';
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }

      if (startPage > 1) {
        pageButtons += `<button class="pagination-page" onclick="changePage(${domainIndex}, 1)">1</button>`;
        if (startPage > 2) pageButtons += `<span style="padding: 0 4px;">...</span>`;
      }

      for (let i = startPage; i <= endPage; i++) {
        pageButtons += `<button class="pagination-page ${i === currentPage ? 'active' : ''}" onclick="changePage(${domainIndex}, ${i})">${i}</button>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) pageButtons += `<span style="padding: 0 4px;">...</span>`;
        pageButtons += `<button class="pagination-page" onclick="changePage(${domainIndex}, ${totalPages})">${totalPages}</button>`;
      }

      return `
        <div class="pagination-controls">
          <div class="pagination-info">
            Showing ${startIndex + 1}-${endIndex} of ${totalRecords} records
          </div>
          <div class="pagination-buttons">
            <button class="pagination-btn" onclick="changePage(${domainIndex}, ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
              Prev
            </button>
            <div class="pagination-pages">
              ${pageButtons}
            </div>
            <button class="pagination-btn" onclick="changePage(${domainIndex}, ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
              Next
            </button>
          </div>
          <div class="pagination-page-size">
            <label>Per page:</label>
            <select onchange="changePageSize(${domainIndex}, this.value)">
              <option value="10" ${pageSize === 10 ? 'selected' : ''}>10</option>
              <option value="25" ${pageSize === 25 ? 'selected' : ''}>25</option>
              <option value="50" ${pageSize === 50 ? 'selected' : ''}>50</option>
              <option value="100" ${pageSize === 100 ? 'selected' : ''}>100</option>
            </select>
          </div>
        </div>
      `;
    }

    async function fetchData() {
      try {
        const response = await fetch('/api/data');
        const result = await response.json();
        if (result.success) {
          data = result.data;
          renderDashboard();
        } else {
          showToast('Failed to load data: ' + result.error, 'error');
        }
      } catch (error) {
        showToast('Failed to connect to server', 'error');
        document.getElementById('domainList').innerHTML = `
          <div class="empty-state">
            <h2>Unable to load data</h2>
            <p>Make sure the server is running and try refreshing the page.</p>
          </div>
        `;
      }
    }

    async function refreshData() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        const response = await fetch('/api/refresh', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
          const msg = result.data.newFilesProcessed.length > 0
            ? `Processed ${result.data.newFilesProcessed.length} new file(s)`
            : 'No new files to process';
          showToast(msg, 'success');
          await fetchData();
        } else {
          showToast('Refresh failed: ' + result.error, 'error');
        }
      } catch (error) {
        showToast('Failed to refresh data', 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Refresh Reports';
    }

    function renderDashboard() {
      if (!data) return;

      // Update header info
      document.getElementById('lastUpdated').textContent = new Date(data.lastUpdated).toLocaleString();
      document.getElementById('filesProcessed').textContent = data.processedFiles.length;

      // Calculate global stats
      let totalMessages = 0;
      let totalPass = 0;
      let totalIssues = 0;

      data.domains.forEach(domain => {
        totalMessages += domain.totalMessages;
        totalPass += domain.passCount;
        totalIssues += domain.issues.length;
      });

      document.getElementById('totalDomains').textContent = data.domains.length;
      document.getElementById('totalMessages').textContent = totalMessages.toLocaleString();
      document.getElementById('overallPassRate').textContent =
        totalMessages > 0 ? Math.round((totalPass / totalMessages) * 100) + '%' : '0%';
      document.getElementById('totalIssues').textContent = totalIssues;

      // Render domain cards
      const domainList = document.getElementById('domainList');

      if (data.domains.length === 0) {
        domainList.innerHTML = `
          <div class="empty-state">
            <h2>No DMARC Reports Found</h2>
            <p>Click "Refresh Reports" to process DMARC XML files from the reports directory.</p>
          </div>
        `;
        return;
      }

      domainList.innerHTML = data.domains.map((domain, index) => renderDomainCard(domain, index)).join('');

      // Render records tables for all domains
      data.domains.forEach((domain, index) => {
        renderRecordsTable(index);
      });
    }

    function renderDomainCard(domain, index) {
      const passRateClass = domain.passRate >= 90 ? 'good' : domain.passRate >= 70 ? 'warning' : 'bad';
      const policyClass = `policy-${domain.policy.p}`;

      return `
        <div class="domain-card">
          <div class="domain-header" onclick="toggleDomain(${index})">
            <div class="domain-name">${escapeHtml(domain.domain)}</div>
            <div class="domain-stats">
              <div class="stat">
                <div class="stat-value">${domain.totalMessages.toLocaleString()}</div>
                <div class="stat-label">Messages</div>
              </div>
              <div class="stat">
                <div class="stat-value">${domain.passCount.toLocaleString()}</div>
                <div class="stat-label">Passed</div>
              </div>
              <div class="stat">
                <div class="stat-value">${domain.failCount.toLocaleString()}</div>
                <div class="stat-label">Failed</div>
              </div>
              <span class="pass-rate ${passRateClass}" title="DMARC pass rate: ${domain.passRate}% of messages passed either DKIM or SPF alignment checks">${domain.passRate}% Pass</span>
              <span class="expand-icon" id="expand-${index}">&#9660;</span>
            </div>
          </div>
          <div class="domain-body" id="domain-body-${index}">
            <div class="section">
              <h3>Policy (from reports)</h3>
              <span class="policy-badge ${policyClass}">p=${domain.policy.p}</span>
              <span class="policy-badge">sp=${domain.policy.sp}</span>
              <span class="policy-badge">adkim=${domain.policy.adkim}</span>
              <span class="policy-badge">aspf=${domain.policy.aspf}</span>
              <span class="policy-badge">pct=${domain.policy.pct}%</span>
            </div>

            <div class="section">
              <h3>
                Current DNS Records
                <button class="btn btn-secondary" onclick="refreshDnsRecords('${escapeHtml(domain.domain)}', ${index})" id="dns-btn-${index}">
                  Refresh DNS
                </button>
              </h3>
              <div id="dns-records-${index}">
                ${domain.dns ? renderDnsRecordsWithCache(domain.dns, domain.domain) : '<p style="color: #666; font-size: 0.9em;">DNS records not yet fetched. Click "Refresh Reports" to fetch DNS, or click "Refresh DNS" for live lookup.</p>'}
              </div>
            </div>

            ${domain.recordAnalysis ? `
              <div class="section">
                <h3>DNS Record Recommendations</h3>
                <div class="record-analysis">
                  ${renderSpfCard(domain.recordAnalysis.spf, domain.domain)}
                  ${renderDkimCard(domain.recordAnalysis.dkim, domain.domain)}
                  ${renderDmarcCard(domain.recordAnalysis.dmarc, domain.domain)}
                </div>
              </div>
            ` : ''}

            ${domain.issues.length > 0 ? `
              <div class="section">
                <h3>Detailed Issues (${domain.issues.length})</h3>
                ${domain.issues.map((issue, i) => renderIssue(issue, index, i)).join('')}
              </div>
            ` : `
              <div class="section">
                <h3>Issues</h3>
                <p style="color: #27ae60;">No issues detected</p>
              </div>
            `}

            ${domain.trends.length > 0 ? `
              <div class="section">
                <h3>Message Volume Trend</h3>
                ${renderTrendChart(domain.trends)}
              </div>
            ` : ''}

            <div class="section">
              <h3>Records (${domain.records.length})</h3>
              <div class="records-container" id="records-table-${index}">
                <!-- Table will be rendered by renderRecordsTable -->
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderIssue(issue, domainIndex, issueIndex) {
      const hasContext = issue.context && issue.context.length > 0;
      const hasRelevantDns = issue.relevantDns && issue.relevantDns.length > 0;
      const hasProposedChanges = issue.proposedChanges && issue.proposedChanges.length > 0;

      return `
        <div class="issue-card">
          <div class="issue-title">
            ${escapeHtml(issue.title)}
            <span class="issue-count">${issue.affectedRecords.toLocaleString()} messages</span>
          </div>
          <div class="issue-explanation">${escapeHtml(issue.explanation)}</div>

          ${hasContext ? `
            <div class="issue-context">
              <div class="issue-context-label">Analysis Based on Your DNS</div>
              ${escapeHtml(issue.context)}
            </div>
          ` : ''}

          <div class="issue-sections-toggle">
            ${hasRelevantDns ? `<span class="toggle-btn" onclick="toggleIssueSection(${domainIndex}, ${issueIndex}, 'dns')">Show Relevant DNS</span>` : ''}
            ${hasProposedChanges ? `<span class="toggle-btn" onclick="toggleIssueSection(${domainIndex}, ${issueIndex}, 'changes')">Show Proposed Changes</span>` : ''}
            <span class="toggle-btn" onclick="toggleIssueSection(${domainIndex}, ${issueIndex}, 'remediation')">Show Remediation Steps</span>
          </div>

          ${hasRelevantDns ? `
            <div class="relevant-dns" id="dns-section-${domainIndex}-${issueIndex}" style="display: none;">
              <div class="relevant-dns-title">Relevant DNS Records</div>
              ${issue.relevantDns.map(dns => `
                <div class="relevant-dns-item">
                  <span class="relevant-dns-type">${dns.type}</span>
                  <div class="relevant-dns-raw">${escapeHtml(dns.raw)}</div>
                  <div class="relevant-dns-explanation">${escapeHtml(dns.explanation)}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}

          ${hasProposedChanges ? `
            <div class="proposed-changes" id="changes-section-${domainIndex}-${issueIndex}" style="display: none;">
              <div class="proposed-changes-title">Proposed DNS Changes</div>
              ${issue.proposedChanges.map((change, changeIdx) => `
                <div class="proposed-change">
                  <div class="proposed-change-header">
                    <span class="proposed-change-type">${change.type}</span>
                    <span class="proposed-change-priority priority-${change.priority}">${change.priority} priority</span>
                  </div>
                  <div class="proposed-change-record">${escapeHtml(change.recordName)}</div>
                  <div class="proposed-change-diff">
                    ${change.current ? `
                      <span class="diff-label diff-current">Current</span>
                      <div class="diff-value">${escapeHtml(change.current)}</div>
                    ` : `
                      <span class="diff-label diff-current">Current</span>
                      <div class="diff-value" style="color: #999; font-style: italic;">Not set</div>
                    `}
                    <span class="diff-label diff-proposed">Proposed</span>
                    <div class="diff-value">${escapeHtml(change.proposed)}<button class="copy-btn" onclick="copyToClipboard('${escapeHtml(change.proposed).replace(/'/g, "\\'")}', event)">Copy</button></div>
                  </div>
                  <div class="proposed-change-explanation">${escapeHtml(change.explanation)}</div>
                </div>
              `).join('')}
            </div>
          ` : ''}

          <div class="issue-remediation" id="remediation-section-${domainIndex}-${issueIndex}" style="display: none;">
${escapeHtml(issue.remediation)}
          </div>

          ${issue.sampleSourceIps.length > 0 ? `
            <div class="ip-list">
              <strong style="font-size: 0.8em;">Sample IPs:</strong>
              ${issue.sampleSourceIps.map(ip => `<span class="ip-badge">${escapeHtml(ip)}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderTrendChart(trends) {
      if (trends.length === 0) return '';

      const maxTotal = Math.max(...trends.map(t => t.totalMessages), 1);

      return `
        <div class="trend-chart">
          ${trends.map(trend => {
            const passHeight = (trend.passCount / maxTotal) * 80;
            const failHeight = (trend.failCount / maxTotal) * 80;
            const date = new Date(trend.dateRange.begin * 1000);
            const label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const total = trend.totalMessages || 1;
            const passPercent = Math.round((trend.passCount / total) * 100);
            const failPercent = Math.round((trend.failCount / total) * 100);

            return `
              <div class="trend-bar-group">
                <div class="trend-bar" style="height: ${passHeight + failHeight}px;">
                  <div class="fail" style="height: ${failHeight}px;" title="Failed: ${trend.failCount} (${failPercent}%)"></div>
                  <div class="pass" style="height: ${passHeight}px;" title="Passed: ${trend.passCount} (${passPercent}%)"></div>
                </div>
                <div class="trend-label">${label}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function toggleDomain(index) {
      const body = document.getElementById(`domain-body-${index}`);
      const icon = document.getElementById(`expand-${index}`);
      body.classList.toggle('open');
      icon.classList.toggle('open');
    }

    function toggleIssueSection(domainIndex, issueIndex, section) {
      const sectionId = `${section}-section-${domainIndex}-${issueIndex}`;
      const elem = document.getElementById(sectionId);
      if (elem) {
        const isHidden = elem.style.display === 'none';
        elem.style.display = isHidden ? 'block' : 'none';
      }
    }

    function toggleRemediation(domainIndex, issueIndex) {
      toggleIssueSection(domainIndex, issueIndex, 'remediation');
    }

    function copyToClipboard(text, event) {
      event.stopPropagation();
      navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 1500);
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function refreshDnsRecords(domain, index) {
      const btn = document.getElementById(`dns-btn-${index}`);
      const container = document.getElementById(`dns-records-${index}`);

      btn.disabled = true;
      btn.textContent = 'Fetching...';
      container.innerHTML = '<div class="dns-loading"><div class="spinner"></div><div>Fetching live DNS records...</div></div>';

      try {
        // Force refresh by adding ?refresh=true
        const response = await fetch(`/api/dns/${encodeURIComponent(domain)}?refresh=true`);
        const result = await response.json();

        if (result.success) {
          container.innerHTML = renderDnsRecordsWithCache(result.data, domain);
          btn.textContent = 'Refresh DNS';
          showToast('DNS records refreshed', 'success');
          // Refresh the main data to get updated enriched issues
          await fetchData();
        } else {
          container.innerHTML = `<p style="color: #e74c3c;">Error: ${escapeHtml(result.error)}</p>`;
          btn.textContent = 'Retry';
        }
      } catch (error) {
        container.innerHTML = `<p style="color: #e74c3c;">Failed to fetch DNS records</p>`;
        btn.textContent = 'Retry';
      }

      btn.disabled = false;
    }

    function renderDnsRecordsWithCache(dns, domain) {
      // Check if DNS is fresh (within last hour)
      const fetchedAt = new Date(dns.fetchedAt);
      const now = new Date();
      const ageMinutes = Math.round((now - fetchedAt) / (1000 * 60));
      const isStale = ageMinutes > 60;

      let html = `<div class="dns-cached-notice ${isStale ? 'dns-stale-notice' : ''}">
        <span>Cached ${ageMinutes < 60 ? `${ageMinutes} minutes ago` : `${Math.round(ageMinutes / 60)} hours ago`}</span>
        ${isStale ? '<span style="font-size: 0.85em;">(Consider refreshing)</span>' : ''}
      </div>`;

      html += renderDnsRecords({ ...dns, domain });
      return html;
    }

    function renderDnsRecords(dns) {
      let html = `<p style="font-size: 0.8em; color: #666; margin-bottom: 15px;">Fetched: ${new Date(dns.fetchedAt).toLocaleString()}</p>`;

      // DMARC Record
      html += '<div class="dns-section">';
      html += `<h4>DMARC Record <span class="dns-status ${dns.dmarc ? 'found' : 'missing'}">${dns.dmarc ? 'Found' : 'Not Found'}</span></h4>`;
      if (dns.dmarc) {
        html += `<div class="dns-record">
          <div class="dns-record-label">_dmarc.${escapeHtml(dns.domain)}</div>
          <div class="dns-record-value">${escapeHtml(dns.dmarc.raw)}</div>
          <div class="dns-detail">
            <span class="dns-detail-item"><strong>Policy:</strong> ${dns.dmarc.policy}</span>
            ${dns.dmarc.subdomainPolicy ? `<span class="dns-detail-item"><strong>Subdomain:</strong> ${dns.dmarc.subdomainPolicy}</span>` : ''}
            ${dns.dmarc.percentage !== undefined ? `<span class="dns-detail-item"><strong>Percentage:</strong> ${dns.dmarc.percentage}%</span>` : ''}
            ${dns.dmarc.adkim ? `<span class="dns-detail-item"><strong>DKIM Align:</strong> ${dns.dmarc.adkim === 'r' ? 'relaxed' : 'strict'}</span>` : ''}
            ${dns.dmarc.aspf ? `<span class="dns-detail-item"><strong>SPF Align:</strong> ${dns.dmarc.aspf === 'r' ? 'relaxed' : 'strict'}</span>` : ''}
          </div>
          ${dns.dmarc.rua ? `<div style="margin-top: 8px; font-size: 0.85em;"><strong>Aggregate Reports:</strong> ${dns.dmarc.rua.map(r => escapeHtml(r)).join(', ')}</div>` : ''}
        </div>`;
      } else {
        html += '<p style="color: #dc3545;">No DMARC record found. You should add a DMARC record to enable email authentication reporting.</p>';
      }
      html += '</div>';

      // SPF Record
      html += '<div class="dns-section">';
      html += `<h4>SPF Record <span class="dns-status ${dns.spf ? (dns.spf.hasError ? 'error' : 'found') : 'missing'}">${dns.spf ? (dns.spf.hasError ? 'Error' : 'Found') : 'Not Found'}</span></h4>`;
      if (dns.spf) {
        html += `<div class="dns-record">
          <div class="dns-record-label">${escapeHtml(dns.domain)} TXT</div>
          <div class="dns-record-value">${escapeHtml(dns.spf.raw)}</div>
          ${dns.spf.hasError ? `<p style="color: #dc3545; margin-top: 8px;">${escapeHtml(dns.spf.errorMessage)}</p>` : ''}
          <div class="dns-detail">
            <span class="dns-detail-item"><strong>Default:</strong> ${dns.spf.all}</span>
            <span class="dns-detail-item ${dns.spf.lookupCount > 10 ? 'style="background: #f8d7da;"' : ''}"><strong>DNS Lookups:</strong> ${dns.spf.lookupCount}/10</span>
          </div>
          ${dns.spf.includes.length > 0 ? `
            <div class="dns-includes">
              <strong style="font-size: 0.85em;">Includes:</strong>
              ${dns.spf.includes.map(inc => `<span class="dns-include-badge">${escapeHtml(inc)}</span>`).join('')}
            </div>
          ` : ''}
          ${dns.spf.ipv4.length > 0 ? `
            <div class="dns-includes">
              <strong style="font-size: 0.85em;">IPv4:</strong>
              ${dns.spf.ipv4.map(ip => `<span class="ip-badge">${escapeHtml(ip)}</span>`).join('')}
            </div>
          ` : ''}
          ${dns.spf.ipv6.length > 0 ? `
            <div class="dns-includes">
              <strong style="font-size: 0.85em;">IPv6:</strong>
              ${dns.spf.ipv6.map(ip => `<span class="ip-badge">${escapeHtml(ip)}</span>`).join('')}
            </div>
          ` : ''}
        </div>`;
      } else {
        html += '<p style="color: #dc3545;">No SPF record found. You should add an SPF record to specify authorized email senders.</p>';
      }
      html += '</div>';

      // DKIM Records
      html += '<div class="dns-section">';
      html += `<h4>DKIM Records <span class="dns-status ${dns.dkim.length > 0 ? 'found' : 'missing'}">${dns.dkim.length > 0 ? `${dns.dkim.length} Found` : 'None Found'}</span></h4>`;
      if (dns.dkim.length > 0) {
        dns.dkim.forEach(dkim => {
          html += `<div class="dkim-selector">
            <div class="dkim-selector-name">${escapeHtml(dkim.selector)}._domainkey.${escapeHtml(dns.domain)}</div>
            <div class="dns-detail" style="margin-top: 5px;">
              ${dkim.version ? `<span class="dns-detail-item"><strong>Version:</strong> ${dkim.version}</span>` : ''}
              ${dkim.keyType ? `<span class="dns-detail-item"><strong>Key Type:</strong> ${dkim.keyType}</span>` : ''}
              ${dkim.flags ? `<span class="dns-detail-item"><strong>Flags:</strong> ${dkim.flags}</span>` : ''}
            </div>
            ${dkim.publicKey ? `<div style="margin-top: 5px; font-size: 0.8em; color: #666;">Public Key: ${escapeHtml(dkim.publicKey)}</div>` : ''}
          </div>`;
        });
      } else {
        html += '<p style="color: #856404;">No DKIM records found for common selectors. DKIM may still be configured with a custom selector.</p>';
      }
      html += '</div>';

      // Errors
      if (dns.errors.length > 0) {
        html += '<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px;">';
        html += '<strong style="color: #856404;">Lookup Warnings:</strong>';
        html += '<ul style="margin: 5px 0 0 20px; color: #856404; font-size: 0.85em;">';
        dns.errors.forEach(err => {
          html += `<li>${escapeHtml(err)}</li>`;
        });
        html += '</ul></div>';
      }

      return html;
    }

    function renderSpfCard(spf, domain) {
      const unresolvedIssues = spf.issues.filter(i => !i.resolvedByDns);
      const hasUnresolvedIssues = unresolvedIssues.length > 0 || spf.identifiedSenders.some(s => !s.inCurrentSpf);
      const allResolved = spf.issues.length > 0 && unresolvedIssues.length === 0;
      const cardClass = hasUnresolvedIssues ? 'has-issues' : 'no-issues';
      const statusClass = !spf.current ? 'status-missing' : (hasUnresolvedIssues ? 'status-warning' : 'status-ok');
      const statusText = !spf.current ? 'Missing' : (hasUnresolvedIssues ? 'Needs Update' : (allResolved ? 'Fixed' : 'OK'));

      let html = `<div class="record-card ${cardClass}">
        <div class="record-card-header">
          <span class="record-type">SPF</span>
          <div class="record-status">
            <span class="record-status-badge ${statusClass}">${statusText}</span>
          </div>
        </div>
        <div class="record-card-body">`;

      // Current record
      if (spf.current) {
        html += `<div class="current-record">
          <div class="current-record-label">Current Record</div>
          <div class="current-record-value">${escapeHtml(spf.current.raw)}</div>
        </div>`;
      } else {
        html += `<div class="current-record">
          <div class="current-record-label">Current Record</div>
          <div class="current-record-value" style="color: #999; font-style: italic;">No SPF record found</div>
        </div>`;
      }

      // Identified senders
      if (spf.identifiedSenders.length > 0) {
        html += `<div class="identified-senders">
          <div class="identified-senders-title">Identified Email Senders</div>
          ${spf.identifiedSenders.map(sender => `
            <div class="sender-item">
              <span class="sender-name">${escapeHtml(sender.name)}</span>
              <div class="sender-status">
                <span class="sender-messages">${sender.messageCount.toLocaleString()} msgs</span>
                ${sender.inCurrentSpf
                  ? '<span class="sender-in-spf"> In SPF</span>'
                  : '<span class="sender-missing"> Missing</span>'}
              </div>
            </div>
          `).join('')}
        </div>`;
      }

      // Issues summary with resolution status
      if (spf.issues.length > 0) {
        const unresolvedIssues = spf.issues.filter(i => !i.resolvedByDns);
        const resolvedIssues = spf.issues.filter(i => i.resolvedByDns);

        html += `<div class="issues-summary">
          <div class="issues-summary-title">
            Related Issues
            ${unresolvedIssues.length > 0 ? `<span class="unresolved-count">${unresolvedIssues.length} active</span>` : ''}
            ${resolvedIssues.length > 0 ? `<span class="resolved-count">${resolvedIssues.length} resolved</span>` : ''}
          </div>
          ${unresolvedIssues.map(issue => `
            <div class="issue-with-status">
              <span class="issue-chip unresolved">${escapeHtml(issue.title)}</span>
              <span class="resolution-status unresolved">${escapeHtml(issue.resolutionStatus)}</span>
            </div>
          `).join('')}
          ${resolvedIssues.length > 0 ? `
            <div class="issues-summary-resolved">
              ${resolvedIssues.map(issue => `
                <div class="issue-with-status">
                  <span class="issue-chip resolved"> ${escapeHtml(issue.title)}</span>
                  <span class="resolution-status resolved">${escapeHtml(issue.resolutionStatus)}</span>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>`;
      }

      // Unidentified IPs
      if (spf.unidentifiedIps.length > 0) {
        html += `<div style="margin: 12px 0; padding: 10px; background: #fff3e0; border-radius: 6px;">
          <div style="font-size: 0.8em; font-weight: 600; color: #e65100; margin-bottom: 6px;">Unidentified IPs (investigate)</div>
          <div style="font-size: 0.8em; color: #666;">
            ${spf.unidentifiedIps.slice(0, 5).map(ip => `${ip.ip} (${ip.messageCount} msgs)`).join(', ')}
            ${spf.unidentifiedIps.length > 5 ? ` +${spf.unidentifiedIps.length - 5} more` : ''}
          </div>
        </div>`;
      }

      // Proposed record
      if (spf.proposed) {
        html += `<div class="proposed-record">
          <div class="proposed-record-header">
            <span class="proposed-record-label">Recommended SPF Record</span>
            <button class="copy-record-btn" onclick="copyToClipboard('${escapeHtml(spf.proposed.record).replace(/'/g, "\\'")}', event)">Copy</button>
          </div>
          <div class="proposed-record-value">${escapeHtml(spf.proposed.record)}</div>
          ${spf.proposed.changes.length > 0 ? `
            <ul class="proposed-changes-list">
              ${spf.proposed.changes.map(change => `<li>${escapeHtml(change)}</li>`).join('')}
            </ul>
          ` : ''}
        </div>`;
      } else if (!hasUnresolvedIssues) {
        html += `<div class="no-changes-needed"> No changes needed</div>`;
      }

      html += `</div></div>`;
      return html;
    }

    function renderDkimCard(dkim, domain) {
      const unresolvedIssues = dkim.issues.filter(i => !i.resolvedByDns);
      const hasUnresolvedIssues = unresolvedIssues.length > 0 || dkim.proposed.length > 0;
      const allResolved = dkim.issues.length > 0 && unresolvedIssues.length === 0 && dkim.proposed.length === 0;
      const cardClass = hasUnresolvedIssues ? 'has-issues' : 'no-issues';
      const statusClass = dkim.current.length === 0 ? 'status-missing' : (hasUnresolvedIssues ? 'status-warning' : 'status-ok');
      const statusText = dkim.current.length === 0 ? 'Not Found' : (hasUnresolvedIssues ? 'Needs Update' : (allResolved ? 'Fixed' : 'OK'));

      let html = `<div class="record-card ${cardClass}">
        <div class="record-card-header">
          <span class="record-type">DKIM</span>
          <div class="record-status">
            <span class="record-status-badge ${statusClass}">${statusText}</span>
            ${dkim.current.length > 0 ? `<span style="font-size: 0.8em; color: #666;">${dkim.current.length} selector(s)</span>` : ''}
          </div>
        </div>
        <div class="record-card-body">`;

      // Current selectors
      if (dkim.current.length > 0) {
        html += `<div class="current-record">
          <div class="current-record-label">Current DKIM Selectors</div>
          ${dkim.current.map(d => `
            <div style="background: white; padding: 6px 8px; border-radius: 4px; margin: 4px 0; font-size: 0.85em;">
              <strong>${escapeHtml(d.selector)}</strong>._domainkey.${escapeHtml(domain)}
              ${d.found ? '<span style="color: #2e7d32; margin-left: 8px;"></span>' : '<span style="color: #c62828; margin-left: 8px;"></span>'}
            </div>
          `).join('')}
        </div>`;
      } else {
        html += `<div class="current-record">
          <div class="current-record-label">Current DKIM Selectors</div>
          <div class="current-record-value" style="color: #999; font-style: italic;">No DKIM selectors found</div>
        </div>`;
      }

      // Issues summary with resolution status
      if (dkim.issues.length > 0) {
        const unresolvedIssues = dkim.issues.filter(i => !i.resolvedByDns);
        const resolvedIssues = dkim.issues.filter(i => i.resolvedByDns);

        html += `<div class="issues-summary">
          <div class="issues-summary-title">
            Related Issues
            ${unresolvedIssues.length > 0 ? `<span class="unresolved-count">${unresolvedIssues.length} active</span>` : ''}
            ${resolvedIssues.length > 0 ? `<span class="resolved-count">${resolvedIssues.length} resolved</span>` : ''}
          </div>
          ${unresolvedIssues.map(issue => `
            <div class="issue-with-status">
              <span class="issue-chip unresolved">${escapeHtml(issue.title)}</span>
              <span class="resolution-status unresolved">${escapeHtml(issue.resolutionStatus)}</span>
            </div>
          `).join('')}
          ${resolvedIssues.length > 0 ? `
            <div class="issues-summary-resolved">
              ${resolvedIssues.map(issue => `
                <div class="issue-with-status">
                  <span class="issue-chip resolved"> ${escapeHtml(issue.title)}</span>
                  <span class="resolution-status resolved">${escapeHtml(issue.resolutionStatus)}</span>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>`;
      }

      // Proposed changes
      if (dkim.proposed.length > 0) {
        html += `<div class="proposed-record">
          <div class="proposed-record-label">Recommended Actions</div>
          ${dkim.proposed.map(p => `
            <div class="dkim-proposed-item">
              <div class="dkim-selector-name">${escapeHtml(p.recordName)}</div>
              <div class="dkim-explanation">${escapeHtml(p.explanation)}</div>
            </div>
          `).join('')}
        </div>`;
      } else if (!hasUnresolvedIssues) {
        html += `<div class="no-changes-needed"> No changes needed</div>`;
      }

      html += `</div></div>`;
      return html;
    }

    function renderDmarcCard(dmarc, domain) {
      const unresolvedIssues = dmarc.issues.filter(i => !i.resolvedByDns);
      const hasUnresolvedIssues = unresolvedIssues.length > 0 || dmarc.proposed !== null;
      const allResolved = dmarc.issues.length > 0 && unresolvedIssues.length === 0 && dmarc.proposed === null;
      const cardClass = hasUnresolvedIssues ? 'has-issues' : 'no-issues';
      const statusClass = !dmarc.current ? 'status-missing' : (hasUnresolvedIssues ? 'status-warning' : 'status-ok');
      const statusText = !dmarc.current ? 'Missing' : (hasUnresolvedIssues ? 'Needs Update' : (allResolved ? 'Fixed' : 'OK'));

      let html = `<div class="record-card ${cardClass}">
        <div class="record-card-header">
          <span class="record-type">DMARC</span>
          <div class="record-status">
            <span class="record-status-badge ${statusClass}">${statusText}</span>
            ${dmarc.current ? `<span style="font-size: 0.8em; color: #666;">p=${dmarc.current.policy}</span>` : ''}
          </div>
        </div>
        <div class="record-card-body">`;

      // Current record
      if (dmarc.current) {
        html += `<div class="current-record">
          <div class="current-record-label">Current Record</div>
          <div class="current-record-value">${escapeHtml(dmarc.current.raw)}</div>
        </div>`;
      } else {
        html += `<div class="current-record">
          <div class="current-record-label">Current Record</div>
          <div class="current-record-value" style="color: #999; font-style: italic;">No DMARC record found</div>
        </div>`;
      }

      // Issues summary with resolution status
      if (dmarc.issues.length > 0) {
        const unresolvedIssues = dmarc.issues.filter(i => !i.resolvedByDns);
        const resolvedIssues = dmarc.issues.filter(i => i.resolvedByDns);

        html += `<div class="issues-summary">
          <div class="issues-summary-title">
            Related Issues
            ${unresolvedIssues.length > 0 ? `<span class="unresolved-count">${unresolvedIssues.length} active</span>` : ''}
            ${resolvedIssues.length > 0 ? `<span class="resolved-count">${resolvedIssues.length} resolved</span>` : ''}
          </div>
          ${unresolvedIssues.map(issue => `
            <div class="issue-with-status">
              <span class="issue-chip unresolved">${escapeHtml(issue.title)}</span>
              <span class="resolution-status unresolved">${escapeHtml(issue.resolutionStatus)}</span>
            </div>
          `).join('')}
          ${resolvedIssues.length > 0 ? `
            <div class="issues-summary-resolved">
              ${resolvedIssues.map(issue => `
                <div class="issue-with-status">
                  <span class="issue-chip resolved"> ${escapeHtml(issue.title)}</span>
                  <span class="resolution-status resolved">${escapeHtml(issue.resolutionStatus)}</span>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>`;
      }

      // Proposed record
      if (dmarc.proposed) {
        html += `<div class="proposed-record">
          <div class="proposed-record-header">
            <span class="proposed-record-label">Recommended DMARC Record</span>
            <button class="copy-record-btn" onclick="copyToClipboard('${escapeHtml(dmarc.proposed.record).replace(/'/g, "\\'")}', event)">Copy</button>
          </div>
          <div class="proposed-record-value">${escapeHtml(dmarc.proposed.record)}</div>
          ${dmarc.proposed.changes.length > 0 ? `
            <ul class="proposed-changes-list">
              ${dmarc.proposed.changes.map(change => `<li>${escapeHtml(change)}</li>`).join('')}
            </ul>
          ` : ''}
        </div>`;
      } else if (!hasUnresolvedIssues) {
        html += `<div class="no-changes-needed"> No changes needed</div>`;
      }

      html += `</div></div>`;
      return html;
    }

    // Initial load
    fetchData();
  </script>
</body>
</html>
